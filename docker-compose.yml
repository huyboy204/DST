services:
  dst-server:
    image: ghcr.io/huyboy204/dst:latest
    container_name: dst-dedicated-server
    restart: "on-failure:5"
    
    ports:
      # Game ports - MUST be port forwarded for internet access
      - "10999:10999/udp"  # Master shard
      - "11000:11000/udp"  # Caves shard
    
    environment:
      # REQUIRED: Get your cluster token from https://accounts.klei.com/account/game/servers?game=DontStarveTogether
      - CLUSTER_TOKEN=${CLUSTER_TOKEN}
      
      # Server configuration
      - CLUSTER_NAME=${CLUSTER_NAME:-My DST Server}
      - CLUSTER_DESCRIPTION=${CLUSTER_DESCRIPTION:-A Don't Starve Together Server}
      - CLUSTER_PASSWORD=${CLUSTER_PASSWORD:-}
      - CLUSTER_INTENTION=${CLUSTER_INTENTION:-cooperative}
      - MAX_PLAYERS=${MAX_PLAYERS:-6}
      - GAME_MODE=${GAME_MODE:-survival}
      - PVP=${PVP:-false}
      - PAUSE_WHEN_EMPTY=${PAUSE_WHEN_EMPTY:-true}
      
      # World generation
      - MASTER_PRESET=${MASTER_PRESET:-SURVIVAL_TOGETHER}
      - CAVES_PRESET=${CAVES_PRESET:-DST_CAVE}
      
      # Server management
      - AUTO_UPDATE=${AUTO_UPDATE:-true}
      - TICK_RATE=${TICK_RATE:-15}
      - SHUTDOWN_TIMEOUT=${SHUTDOWN_TIMEOUT:-30}
    
    volumes:
      # Persistent server data - mount to host for easy access
      - ./data:/home/steam/.klei/DoNotStarveTogether/MyDediServer
      - bin:/home/steam/dst/bin64
    
    healthcheck:
      test: ["CMD-SHELL", "/bin/bash /home/steam/healthcheck.sh"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
    
    stdin_open: true
    tty: true

volumes:
  bin: